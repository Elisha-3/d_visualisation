<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Survey Dashboard - Oracom</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">

  <div class="container py-5">
    <h2 class="text-center mb-5">ðŸ“Š Survey Visualization Dashboard</h2>

    <!-- SECTION 1: Upload Form -->
    <section class="card shadow p-4 mb-5">
      <h4>Upload File</h4>
      <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data">
        <div class="row g-2 align-items-center">
          <div class="col-md-8">
            <input type="file" name="file" class="form-control" required>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-primary w-100">Upload</button>
          </div>
        </div>
      </form>
      <div id="responseMessage" class="mt-3 text-success"></div>
    </section>

    <!-- SECTION 2: Q1 Graphs -->
    <section class="card shadow p-4 mb-5">
      <h4>Q1 Responses (Visualization)</h4>
      <div class="row mt-3">
        <div class="col-md-6 mb-4">
          <canvas id="donutChart" width="400" height="400"></canvas>
        </div>
        <div class="col-md-6 mb-4">
          <canvas id="barChart" width="400" height="400"></canvas>
        </div>
      </div>
    </section>

    <!-- SECTION 3: Q2 and Q3 Text Responses -->
    <section class="card shadow p-4">
      <div class="row">
        <div class="col-md-6">
          <h5>Q2 Responses</h5>
          <ul id="q2Text" class="list-group">
            <li class="list-group-item">Loading...</li>
          </ul>
        </div>
        <div class="col-md-6">
          <h5>Q3 Responses</h5>
          <ul id="q3Text" class="list-group">
            <li class="list-group-item">Loading...</li>
          </ul>
        </div>
      </div>
    </section>
  </div>

  <script>
    // Handle upload form submission
    $('#uploadForm').on('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      $('#responseMessage').text('Uploading...').removeClass('text-danger').addClass('text-info');
      $.ajax({
        url: '/upload',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        success: function(response) {
          $('#responseMessage').text(response.message).removeClass('text-info text-danger').addClass('text-success');
          loadCharts(); 
          // Reload charts after successful upload
        },
        error: function(xhr) {
          const error = xhr.responseJSON ? xhr.responseJSON.error : 'Upload failed';
          $('#responseMessage').text(error).removeClass('text-info text-success').addClass('text-danger');
        }
      });
    });

    // Load charts and text data
    function loadCharts() {
      $.get('/api/data', function(data) {
        // Donut Chart (Q1 Distribution)
        const donutCtx = document.getElementById('donutChart').getContext('2d');
        new Chart(donutCtx, {
          type: 'pie',
          data: {
            labels: ['Q1', 'Q2', 'Q3'],
            datasets: [{
              label: 'Q1 Distribution',
              data: [data.q1_dist.Q1 * 100, data.q1_dist.Q2 * 100, data.q1_dist.Q3 * 100],
              backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: 'Q1 Responses' },
              legend: { position: 'bottom' }
            }
          }
        });

        // Bar Chart (Q1 Counts)
        const barCtx = document.getElementById('barChart').getContext('2d');
        new Chart(barCtx, {
          type: 'bar',
          data: {
            labels: Object.keys(data.q1_counts),
            datasets: [{
              label: 'Count',
              data: Object.values(data.q1_counts),
              backgroundColor: '#36A2EB'
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Count' } } },
            plugins: { legend: { display: false } }
          }
        });

        // Q2 and Q3 Text
        $('#q2Text').html(data.q2.map(item => `<li class="list-group-item">${item}</li>`).join(''));
        $('#q3Text').html(data.q3.map(item => `<li class="list-group-item">${item}</li>`).join(''));
      }).fail(function(xhr) {
        console.error('Error loading data:', xhr.responseJSON ? xhr.responseJSON.error : xhr.statusText);
      });
    }

    // Initial load
    loadCharts();
  </script>
</body>
</html>